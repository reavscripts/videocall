<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<meta name="theme-color" content="#0a0a12"> <meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

<title>#CHAN - Neural Uplink</title> <link rel="manifest" href="manifest.json">

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;800&family=Roboto+Mono:wght@400;700&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />

<link rel="stylesheet" href="style.css" /> <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/images/favicon/favicon-16x16.png">
</head>
<body class="retro-terminal-theme"> <div id="nickname-overlay">
    <div class="cyber-container">
        <img id="app-logo" src="images/logo.png" alt="Logo" class="neon-glitch" />
        <h1 class="terminal-title">SERVER UPLINK ESTABLISHED.</h1>
        <div class="card terminal-card">
            <h2 style="color: var(--neon-cyan)">> LOGIN SEQUENCE</h2>
            <div class="input-group">
                 <span class="input-prefix">ROOM_ID:</span>
                 <input type="text" id="room-id-input" placeholder="channel_name" required class="terminal-input"/>
            </div>
             <div class="input-group">
                 <span class="input-prefix">PASSKEY:</span>
                <input type="password" id="room-password-input" placeholder="(Optional)" class="terminal-input"/>
            </div>
             <div class="input-group">
                 <span class="input-prefix">HANDLE_:</span>
                <input type="text" id="nickname-input" placeholder="Your Nickname" required class="terminal-input"/>
            </div>
            <div class="row">
                <button id="join-button" class="cyber-button">INITIALIZE CONNECTION_</button>
            </div>
        </div>
    </div>
</div>

<div id="settings-modal" class="hidden">
    <div class="settings-content terminal-border">
        <div class="settings-header">
            <h3>> SYSTEM CONFIG</h3>
            <button id="close-settings-btn"><span class="material-icons">close</span></button>
        </div>
        <div class="settings-body">
             <div class="setting-item">
                <span>Dark / Light Theme (Override)</span>
                <label class="switch">
                    <input type="checkbox" id="theme-toggle">
                    <span class="slider round"></span>
                </label>
            </div>
			<hr class="separator">
			<div class="setting-item" style="display:block;">
				<span style="display:block; margin-bottom:10px;">Application Background</span>
				<div id="background-options" class="bg-selection-grid"></div>
			</div>
            <hr class="separator">
            <div class="setting-item">
                <span>Server Management</span>
                <button id="open-admin-login" class="btn-secondary cyber-button-small">Admin Login</button>
            </div>
        </div>
    </div>
</div>

<div id="admin-panel" class="hidden terminal-border">
     <div class="admin-header">
        <h3>üõ°Ô∏è ROOT ACCESS</h3>
        <button id="close-admin-btn"><span class="material-icons">close</span></button>
    </div>
    <div class="admin-content">
        <div id="admin-login-view">
            <input type="password" id="admin-password-input" placeholder="ROOT Password" class="terminal-input"/>
            <button id="admin-login-btn" class="cyber-button-small">AUTHENTICATE</button>
            <p id="admin-msg" style="color: var(--neon-pink); margin-top: 10px; font-family: var(--terminal-font);"></p>
        </div>
        <div id="admin-dashboard-view" class="hidden">
            <div class="stats-bar terminal-text">
                <span>USERS: <strong id="admin-total-users" style="color:var(--neon-cyan)">0</strong></span>
                <span style="margin-left:15px;">BANNED_IPS: <strong id="admin-banned-count" style="color:var(--neon-pink);">0</strong></span>
            </div>
            
            <div class="admin-section-title">> SYSTEM LOGS</div>
            <div id="admin-logs-console" class="terminal-console">
                <div class="log-entry system">Waiting for events...</div>
            </div>

            <div class="admin-section-title">> CHANNEL MANAGEMENT</div>
            <div id="admin-rooms-list"></div>
            <button id="admin-refresh-btn" class="cyber-button-small">REFRESH DATA</button>
        </div>
    </div>
</div>
<div id="conference-container" class="hidden split-layout">
    <header id="room-header" class="terminal-header">
        <div class="header-left">
            <div class="room-title-wrapper">
                <h3><span style="color: var(--neon-pink)">#</span><span id="room-name-display" class="neon-text"></span></h3>
            </div>
        </div>

        <div id="room-topic-container">
            <div id="room-topic-display" class="hidden terminal-topic"></div>
        </div>
        
        <div class="header-controls">
            <button id="op-settings-btn" class="hidden terminal-icon-btn" title="OP Command Console">
                <span class="material-icons">admin_panel_settings</span>
            </button>
            <button id="share-room-link" class="terminal-icon-btn" title="Share Uplink">
                <span class="material-icons">link</span>
            </button>
            <button id="settings-btn-room" class="terminal-icon-btn" title="Config">
                <span class="material-icons">settings</span>
            </button>
        </div>
    </header>

    <main id="main-split-area">
        
        <section id="video-section">
             <div id="videos-grid">
                <div id="local-feed" class="video-feed ratio-4-3 hidden neon-border" data-peer-id="local">
                    <video id="local-video" autoplay playsinline muted></video>
                    <div class="video-label terminal-label">
                        <span id="local-mic-status" class="material-icons">mic</span>
                        <span id="local-nickname-display">Tu</span> 
                    </div>
                </div>
                </div>
             <div id="main-controls-bar" class="cyber-controls">
                <button id="toggle-audio-button" class="cyber-ctrl-btn" title="Mute/Unmute Audio"><span class="material-icons">mic</span></button>
                <button id="toggle-video-button" class="cyber-ctrl-btn" title="Disable/Enable Video"><span class="material-icons">videocam</span></button>
                
                <button id="switch-camera-button" class="mobile-only cyber-ctrl-btn" title="Switch Camera">
                    <span class="material-icons">flip_camera_ios</span>
                </button>

                <button id="more-options-btn" class="cyber-ctrl-btn" title="Extras">
                    <span class="material-icons">read_more</span>
                </button>

                <button id="disconnect-button" class="cyber-ctrl-btn danger" title="Disconnect"><span class="material-icons">call_end</span></button>
            </div>
        </section>

        <aside id="chat-terminal" class="terminal-panel">
            <div class="terminal-header-bar">
                > #CONNECTION_LOG
            </div>
            <div id="messages-container" class="terminal-body">
                </div>
            
            <div id="typing-indicator" class="hidden terminal-typing">
                <span id="typing-text">> Someone is typing_</span>
            </div>

            <div id="chat-input-area" class="terminal-input-area">
                <span class="terminal-prompt">$</span>
                <input type="text" id="chat-message-input" placeholder="Type command or message..." autocomplete="off" class="terminal-chat-input" />
                
                <button id="emoji-toggle-btn" class="terminal-icon-btn small" title="Inserisci Emoji">‚ò∫</button>
                
                <button id="send-chat-button" class="terminal-send-btn">
                    ENTER
                </button>
            </div>
        </aside>

    </main> <div id="whiteboard-container" class="hidden neon-border">
        <div class="wb-toolbar">
             <div class="wb-colors">
                <div class="color-btn active" style="background: #ffffff;" data-color="#ffffff"></div>
                <div class="color-btn" style="background: #ff00ff;" data-color="#ff00ff"></div> <div class="color-btn" style="background: #00f7ff;" data-color="#00f7ff"></div> <div class="color-btn" style="background: #0055ff;" data-color="#0055ff"></div> <div class="color-btn" style="background: #ffd740;" data-color="#ffd740"></div>
            </div>
            <div class="wb-actions">
                <button id="wb-undo-btn" class="terminal-icon-btn"><span class="material-icons">undo</span></button>
                <button id="wb-clear-btn" class="terminal-icon-btn"><span class="material-icons">delete</span></button>
                <button id="wb-close-btn" class="terminal-icon-btn"><span class="material-icons">close</span></button>
            </div>
        </div>
        <canvas id="whiteboard-canvas"></canvas>
    </div>
    
    <div id="meeting-transcript-panel" class="hidden terminal-border">
         </div>
</div>

<div id="extras-menu" class="hidden cyber-menu">
    <div class="menu-item" id="transfer-file-button">
		<span class="material-icons neon-icon-cyan">folder_open</span>
		<span>Send File</span>
	</div>
    </div>

<template id="remote-video-template">
    <div class="video-feed ratio-4-3 neon-border">
        <div class="video-content-wrapper">
            <video autoplay playsinline></video>
            <div class="subtitle-overlay hidden terminal-text"></div>
        </div>
        <div class="video-label terminal-label">
            <span class="remote-mic-status material-icons">mic</span>
            <span class="remote-nickname terminal-font"></span>
        </div>
        <button class="context-menu-trigger terminal-icon-btn small" title="User Options">
            <span class="material-icons">more_vert</span>
        </button>
    </div>
</template>

<script type="module">
    // Importiamo direttamente dai server CDN ottimizzati
    import { createPopup } from 'https://unpkg.com/@picmo/popup-picker@latest/dist/index.js?module';
    import { createPicker } from 'https://unpkg.com/picmo@latest/dist/index.js?module';

    document.addEventListener('DOMContentLoaded', () => {
        const trigger = document.getElementById('emoji-toggle-btn');
        const input = document.getElementById('chat-message-input');
        
        if (!trigger || !input) {
            console.error("Elementi chat non trovati per Emoji Picker");
            return;
        }
        
        const picker = createPopup({
            rootElement: document.body,
            triggerElement: trigger,
            position: 'auto' 
        }, {
            theme: 'dark',
            locale: 'it',
            autoFocus: 'search',
            showPreview: false
        });

        trigger.addEventListener('click', () => {
            picker.toggle();
        });

        picker.addEventListener('emoji:select', (selection) => {
            const start = input.selectionStart;
            const end = input.selectionEnd;
            const text = input.value;
            input.value = text.substring(0, start) + selection.emoji + text.substring(end, text.length);
            input.selectionStart = input.selectionEnd = start + selection.emoji.length;
            input.focus();
        });
    });
</script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.4/socket.io.js"></script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.8/purify.min.js"></script>
<script src="app.js"></script>

</body>
</html>