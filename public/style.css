:root{
    --primary-color:#00bcd4;
    --accent-color:#ff9800;
    --bg:#0f0f10;
    --surface:#1e1e1e;
    --muted:#b0b0b0;
    --danger:#ef5350;
    --panel-width-desktop: 300px;
}
*{box-sizing:border-box}
html,body{
    height:100%;
    margin:0;
    background:var(--bg);
    color:#fff;
    font-family:Roboto,Arial,sans-serif;
}
.hidden{display:none!important}

/* Overlay Iniziale */
#nickname-overlay{
    position:fixed;
    inset:0;
    background:rgba(0,0,0,0.85);
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:center;
    gap:20px;
    z-index:200;
}

#app-logo{
    width:180px;
    height:auto;
    margin-bottom:10px;
    animation:fadeIn 0.4s ease;
}

.card{
    background:var(--surface);
    padding:28px;
    border-radius:10px;
    width:360px;
    max-width:90%;
    box-shadow:0 10px 20px rgba(0,0,0,0.3);
}

.card h2{
    margin-top:0;
    margin-bottom:20px;
    color:var(--primary-color);
    text-align:center;
    font-weight:400;
}

.card input[type="text"]{
    width:100%;
    padding:12px;
    margin-bottom:15px;
    border:1px solid #333;
    border-radius:6px;
    background:var(--bg);
    color:#fff;
    font-size:16px;
}
.card input[type="text"]:focus{
    border-color:var(--primary-color);
    outline:none;
}

.card .row{
    display:flex;
    justify-content:space-between;
    gap:10px;
}

.card button{
    flex-grow:1;
    padding:12px;
    border:none;
    border-radius:6px;
    font-weight:500;
    cursor:pointer;
    transition:background 0.2s ease;
}

#join-button{
    background:var(--primary-color);
    color:var(--surface);
}
#join-button:hover{background:darken(var(--primary-color), 10%);}

#copy-room-link{
    background:var(--surface);
    color:var(--primary-color);
    border:1px solid var(--primary-color);
}

/* MAIN LAYOUT */
#main-container{
    display:flex;
    height:100%;
    width:100%;
    overflow:hidden;
}

#videos-area{
    flex-grow:1;
    display:flex;
    flex-direction:column;
    padding:10px;
    overflow:hidden;
    position:relative;
}

#controls-bar{
    flex-shrink:0;
    display:flex;
    justify-content:center;
    gap:10px;
    padding:10px 0;
    background:rgba(0,0,0,0.5); 
    position:fixed;
    bottom:0;
    left:0;
    right:0;
    z-index:10;
}

#controls-bar button{
    background:var(--surface);
    color:#fff;
    border:none;
    border-radius:50%;
    width:48px;
    height:48px;
    display:flex;
    align-items:center;
    justify-content:center;
    cursor:pointer;
    transition:background 0.2s;
    position:relative;
}

#controls-bar button:hover{background:rgba(255,255,255,0.1);}

#controls-bar button .material-icons{font-size:24px;}

/* Pulsanti Toggle (Attivo/Disattivo) */
#toggle-audio-button.active,
#toggle-video-button.active{
    background:var(--danger);
    color:#fff;
}
#toggle-audio-button.active:hover,
#toggle-video-button.active:hover{background:darken(var(--danger), 10%);}

/* Pulsante Disconnetti */
#disconnect-button{
    background:var(--danger);
}
#disconnect-button:hover{background:darken(var(--danger), 10%);}


/* Griglia Video */
#videos-grid{
    flex-grow:1;
    display:flex;
    flex-wrap:wrap;
    gap:10px;
    align-items:center;
    justify-content:center;
    overflow-y:auto;
    overflow-x:hidden; /* Per evitare scroll orizzontale */
    padding-top:10px;
    padding-bottom:10px; 
    transition: padding 0.3s ease;
    height: calc(100% - 70px); /* Spazio per la barra controlli */
}

/* Base Video Feed */
.video-feed{
    position:relative;
    background:#000;
    border-radius:8px;
    overflow:hidden;
    transition:all 0.3s ease;
    cursor:pointer;
    box-shadow:0 4px 8px rgba(0,0,0,0.4);
}

.video-feed video{
    width:100%;
    height:100%;
    object-fit:cover;
    display:block;
}

/* Dimensioni Predefinite (Desktop) */
.video-feed.ratio-4-3{
    width:240px; 
    height:180px; 
}
.video-feed.ratio-16-9{
    width:320px; 
    height:180px; 
}

/* Stile per il Feed Locale */
#local-feed{
    order:100; /* Sposta il feed locale per ultimo */
    border:2px solid var(--primary-color);
}


/* Video in Focus (Modalità a un solo grande video) */
.video-feed.is-focused{
    width:800px!important; 
    height:calc(100vh - 150px)!important; /* Altezza massima 100% viewport - Controlli/Padding */
    order:-1; /* Sposta il video in focus all'inizio */
    max-width:calc(100vw - var(--panel-width-desktop) - 20px); /* Limite per non superare l'area video */
    margin:auto;
    box-shadow:0 0 15px var(--primary-color);
}
.video-feed.is-focused.ratio-4-3{
    width:640px!important; 
}
.video-feed.is-focused.ratio-16-9{
    width:800px!important; 
}
/* Gestione della ratio 4:3 in focus per schermi larghi */
.video-feed.is-focused.ratio-4-3 video {
    aspect-ratio: 4 / 3;
    width: auto;
    height: 100%;
}
/* Gestione della ratio 16:9 in focus */
.video-feed.is-focused.ratio-16-9 video {
    aspect-ratio: 16 / 9;
    width: 100%;
    height: auto;
}


/* Etichetta Video (Nickname e Stato Audio) */
.video-label{
    position:absolute;
    bottom:0;
    left:0;
    right:0;
    background:rgba(0,0,0,0.5);
    padding:4px 8px;
    display:flex;
    align-items:center;
    gap:5px;
    font-size:14px;
}

.remote-mic-status, #local-mic-status{
    color:var(--danger); /* Icona rossa per muto */
    font-size:18px;
}

/* Icona verde per audio attivo */
.remote-mic-status.active, #local-mic-status.active{
    color:#4caf50; 
}

/* Indicatore di chi sta parlando */
.video-feed.is-talking{
    border:2px solid var(--accent-color);
    box-shadow:0 0 8px var(--accent-color);
}

/* Menu Contestuale Trigger */
.context-menu-trigger{
    position:absolute;
    top:5px;
    right:5px;
    background:rgba(0,0,0,0.5);
    color:#fff;
    border:none;
    border-radius:4px;
    width:30px;
    height:30px;
    display:flex;
    align-items:center;
    justify-content:center;
    cursor:pointer;
    z-index:5;
    opacity:0; /* Nascosto su desktop */
    transition:opacity 0.2s;
}

.video-feed:hover .context-menu-trigger{
    opacity:1; /* Mostrato al passaggio del mouse su desktop */
}

/* Pulsante Mute Remoto */
.remote-mute-toggle{
    position:absolute;
    top:5px;
    left:5px;
    background:rgba(0,0,0,0.5);
    color:#fff;
    border:none;
    border-radius:4px;
    width:30px;
    height:30px;
    display:flex;
    align-items:center;
    justify-content:center;
    cursor:pointer;
    z-index:5;
    transition:background 0.2s;
}
.remote-mute-toggle:hover{background:rgba(0,0,0,0.7);}
.remote-mute-toggle.active{ /* Quando l'audio è silenziato localmente */
    background:var(--danger);
}


/* Menu Contestuale */
#remote-context-menu{
    position:fixed;
    background:var(--surface);
    border-radius:8px;
    box-shadow:0 6px 12px rgba(0,0,0,0.5);
    z-index:100;
    min-width:200px;
    padding:5px 0;
}
.menu-item{
    padding:10px 15px;
    display:flex;
    align-items:center;
    gap:10px;
    cursor:pointer;
    transition:background 0.1s;
}
.menu-item:hover{background:#333;}
.menu-item .material-icons{font-size:20px;}


/* CHAT PANEL */
#chat-panel{
    flex-shrink:0;
    width:var(--panel-width-desktop);
    background:var(--surface);
    box-shadow:-2px 0 10px rgba(0,0,0,0.4);
    display:flex;
    flex-direction:column;
    z-index:20;
    height:100%;
    transition:width 0.3s ease;
}

#chat-header{
    flex-shrink:0;
    padding:10px 20px;
    border-bottom:1px solid #333;
    display:flex;
    justify-content:space-between;
    align-items:center;
}

#messages-container{
    flex-grow:1;
    overflow-y:auto;
    padding:15px 20px;
    display:flex;
    flex-direction:column;
    gap:10px;
}

.chat-message{
    max-width:85%;
    padding:8px 12px;
    border-radius:15px;
    line-height:1.4;
    word-wrap:break-word;
}
.chat-message.me{
    align-self:flex-end;
    background:var(--primary-color);
    color:var(--surface);
    border-bottom-right-radius:2px;
}
.chat-message.remote{
    align-self:flex-start;
    background:#333;
    color:#fff;
    border-bottom-left-radius:2px;
}
.chat-message.system{
    align-self:center;
    text-align:center;
    background:transparent;
    color:var(--muted);
    font-size:12px;
    padding:5px;
    max-width:100%;
}
.chat-message .nickname{
    display:block;
    font-weight:bold;
    font-size:12px;
    margin-bottom:2px;
}

.chat-message.remote.dm{
    background:#ffc107; /* Giallo scuro per DM ricevuti */
    color:var(--surface);
}
.chat-message.me.dm{
    background:#9e9e9e; /* Grigio per DM inviati */
    color:var(--surface);
}


#chat-input-area{
    flex-shrink:0;
    padding:10px;
    border-top:1px solid #333;
    display:flex;
    gap:10px;
}

#chat-message-input{
    flex-grow:1;
    padding:10px;
    border:1px solid #444;
    border-radius:6px;
    background:var(--bg);
    color:#fff;
    font-size:14px;
    resize:none;
}
#chat-message-input:focus{
    border-color:var(--primary-color);
    outline:none;
}

#send-chat-button, #hide-chat-btn, #show-chat-btn{
    background:var(--primary-color);
    color:#fff;
    border:none;
    border-radius:6px;
    width:40px;
    height:40px;
    display:flex;
    align-items:center;
    justify-content:center;
    cursor:pointer;
    transition:background 0.2s;
}
#send-chat-button:hover, #hide-chat-btn:hover, #show-chat-btn:hover{background:darken(var(--primary-color), 10%);}

#show-chat-btn{
    position:fixed;
    bottom:68px; /* Sopra la barra controlli */
    right:10px;
    z-index:20;
}

/* Animazioni */
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
@keyframes pulse{0%{box-shadow:0 0 0 0 rgba(255,152,0,0.7)}70%{box-shadow:0 0 0 10px rgba(255,152,0,0)}100%{box-shadow:0 0 0 0 rgba(255,152,0,0)}}


/* --- AVVISO STREAMING --- */
.streaming-indicator{
    position:absolute;
    top:50%;
    left:50%;
    transform:translate(-50%, -50%);
    background:rgba(0,0,0,0.7);
    color:#fff;
    padding:8px 15px;
    border-radius:20px;
    font-size:14px;
    display:flex;
    align-items:center;
    gap:5px;
    z-index:10;
}
.streaming-indicator.private{
    background:var(--danger);
}
.streaming-indicator .material-icons{
    font-size:18px;
}
/* Icona condivisione schermo */
#local-feed .material-icons.screen-share-icon{
    position:absolute;
    top:8px;
    left:8px;
    background:var(--primary-color);
    border-radius:50%;
    padding:5px;
    z-index:5;
    font-size:24px;
}


/* --- MESSAGGI DI NOTIFICA (Toast) --- */
#toast-container {
    position: fixed;
    bottom: 70px; /* Sopra la barra controlli */
    right: 10px;
    z-index: 150;
    display: flex;
    flex-direction: column-reverse; /* I nuovi toast appaiono in alto */
    align-items: flex-end;
    gap: 10px;
}

.toast {
    background: rgba(30, 30, 30, 0.95);
    color: #fff;
    padding: 10px 15px;
    border-radius: 6px;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.5);
    min-width: 250px;
    max-width: 90vw;
    opacity: 0;
    transition: opacity 0.3s ease, transform 0.3s ease;
    transform: translateX(100%);
    display: flex;
    align-items: center;
    gap: 10px;
}

.toast.show {
    opacity: 1;
    transform: translateX(0);
}

.toast.info .material-icons { color: var(--primary-color); }
.toast.success .material-icons { color: #4caf50; }
.toast.error .material-icons { color: var(--danger); }
.toast.warning .material-icons { color: var(--accent-color); }


/* --- MEDIA QUERIES/RESPONSIVE ----------------- */
@media (max-width: 768px) {
    
    #main-container {
        flex-direction: column;
    }
    
    #videos-area {
        padding: 5px;
        flex-grow: 1;
        height: 100%;
    }

    /* Nascondi il pannello Chat (viene mostrato con un overlay) */
    #chat-panel {
        display: none; /* Nascosto per default su mobile */
    }
    #chat-panel.active { 
        display: flex; /* Mostrato quando attivo */
        position: fixed;
        inset: 0;
        width: 100%;
        height: 100%;
        background: var(--surface);
        transform: translateY(100%);
        transition: transform 0.3s ease-in-out;
        z-index: 300;
        flex-direction: column;
        border-radius: 0;
        box-shadow: none;
        overflow: hidden;
    }
    #chat-panel.active { transform: translateY(0); }
    
    /* Layout Mobile: Griglia Video - MODIFICHE CHIAVE QUI */
    #videos-grid {
        flex-direction: column;
        align-items: center; /* Centra i feed orizzontalmente */
        gap: 6px;
        justify-content: flex-start;
        padding-bottom: 70px; 
        /* NUOVE REGOLE PER EVITARE SCROLL ORIZZONTALE */
        width: 100%; /* Assicura che la griglia occupi il 100% */
        overflow-x: hidden; /* Blocca lo scroll orizzontale della griglia */
    }

    /* Regole per tutte le video-feed (sia 4:3 che 16:9) */
    .video-feed { 
        /* Sovrascrive le larghezze fisse del desktop */
        width: 95% !important; /* Forza la larghezza al 95% della viewport */
        height: auto !important; /* Forza l'altezza automatica */
        max-width: 450px; /* Limite massimo per non esagerare su tablet in portrait */
    }
    
    /* Video in focus - Adatta l'altezza al 45% della viewport per avere spazio per gli altri */
    .video-feed.is-focused {
        order: -1; 
        max-height: 45vh; /* Limite l'altezza a una frazione dell'altezza della viewport */
        width: 95% !important; /* Forza la larghezza al 95% */
        height: auto !important; /* Adatta l'altezza in base alla ratio */
        margin-top: 5px; /* Spazio dall'alto */
    }

    /* Regole per assicurare la ratio corretta su mobile */
    .video-feed.is-focused.ratio-4-3 video,
    .video-feed.ratio-4-3 video { 
        aspect-ratio: 4/3;
        width: 100%; /* Assicura che il video riempia il feed */
        height: auto;
    }

    .video-feed.is-focused.ratio-16-9 video,
    .video-feed.ratio-16-9 video { 
        aspect-ratio: 16/9;
        width: 100%; /* Assicura che il video riempia il feed */
        height: auto;
    }

    /* Barre dei Controlli */
    #controls-bar{
        gap: 5px;
        padding: 10px 5px;
    }
    #controls-bar button {
        width: 40px;
        height: 40px;
    }
    #controls-bar button .material-icons{
        font-size: 20px;
    }
    
    /* Su mobile mostra sempre l'icona menu */
    .context-menu-trigger {
        opacity: 1; /* Forzato a 1 */
    }

    /* Intestazione Chat (fissa) */
    #chat-panel h3 {
        flex-shrink: 0; 
        padding: 10px 20px; 
        border-bottom: 1px solid #333; 
    }

    /* Area Messaggi (scorre e occupa lo spazio rimanente) */
    #messages-container {
        flex-grow: 1; 
        overflow-y: auto;
        padding-bottom: 10px;
        padding-top: 15px;
    }
    
    /* Area Input (fissa in fondo) */
    #chat-input-area {
        flex-shrink: 0; 
        border-top: 1px solid #333; 
    }

    /* Toast su mobile */
    #toast-container {
        bottom: 55px; /* Spostato più in alto per non sovrapporsi ai controlli */
        right: 5px;
        left: 5px;
        align-items: center; /* Centra i toast */
    }
    .toast {
        min-width: 95%;
    }
}